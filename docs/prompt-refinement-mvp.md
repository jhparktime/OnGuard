# LLM 프롬프트 개선 - MVP 완성

## 변경 날짜
2026-02-06

## 개선 목표
**친구/가족 일상 대화에서 금전 키워드가 탐지되어도 알림을 방지**하고, 명확한 사기 신호에만 높은 confidence를 부여하여 오탐(False Positive)을 최소화

---

## 핵심 문제점

### 기존 프롬프트의 한계
1. **일상 대화 구분이 약함**
   - "돈 좀 빌려줄래?" (친구) → Rule 0.4~0.5, LLM이 애매하게 판단하면 최종 0.5+ (알림 발생)
   - 키워드 탐지만으로 confidence를 올리는 경향

2. **Confidence 범위가 모호**
   - "0~30: 낮음, 30~60: 애매, 60~100: 높음" 정도만 안내
   - 구체적인 예시 부족

3. **맥락 판단 기준 불명확**
   - "친구·가족 대화 고려"라고만 언급
   - 실제로 어떤 상황에서 낮은 점수를 줘야 하는지 불명확

---

## 개선 사항

### 1. 핵심 원칙 명시

```
# 핵심 원칙
1. **맥락이 일상 대화라면 매우 낮은 점수 (10-25)를 주어 알림을 방지하세요**
   - 친구: "돈 좀 빌려줄래?" → confidence: 10-20 (정상 대화)
   - 가족: "급하게 필요한데 입금 좀" → confidence: 15-25 (일상 부탁)
   
2. **명확한 사기 신호가 여러 개 있을 때만 높은 점수 (70+)**
   - 낯선 번호 + 긴급 + 금전 + URL → confidence: 75-90
   - DB 등록 전화번호/계좌 → confidence: 85-95
   
3. **애매하면 중간 (30-50)으로 주되, 경고 문구에서 불확실성 명시**
```

### 2. Confidence 점수 가이드 상세화

#### **10-25 (정상/매우 낮음)**: 일상 대화 맥락
```
- 친구/가족 간 돈 빌리는 대화
- 일상적 거래 약속 ("입금했어", "계좌 알려줘")
- 금전 관련 단어가 있어도 **대화 흐름이 자연스러움**
- 예: "돈 좀 빌려줄래?", "급하게 필요해", "계좌번호 알려줘"
```

**효과:** 
- Rule 0.4 + LLM 0.15 → 최종 0.22 (알림 X)
- Rule 0.5 + LLM 0.20 → 최종 0.29 (알림 X)

#### **30-50 (주의/애매)**: 불확실한 상황
```
- 맥락이 부족해 판단 어려움
- 금전 요구 + 다소 이상한 표현
- 최근 대화 없이 갑자기 금전 요구
```

**효과:**
- Rule 0.5 + LLM 0.40 → 최종 0.43 (알림 X, 하지만 주의)
- Rule 0.6 + LLM 0.50 → 최종 0.53 (경고 알림, "주의 필요" 메시지)

#### **60-75 (위험)**: 사기 가능성 높음
```
- 긴급성 + 금전 + 의심 URL/전화번호
- 기관 사칭 표현
- 투자/대출 유도 + 고수익 보장
```

**효과:**
- Rule 0.6 + LLM 0.70 → 최종 0.67 (명확한 경고)
- Rule 0.7 + LLM 0.75 → 최종 0.73 (강한 경고)

#### **80-95 (매우 위험)**: 명백한 사기
```
- Counter Scam 112 DB 등록 번호
- KISA 악성 URL
- 경찰청 사기계좌 DB 등록
- 긴급 + 금전 + 인증정보 요구
```

**효과:**
- 강한 신호 → Rule-only 0.85~1.0 (즉시 차단 권고)
- Rule 0.5 + LLM 0.90 → 최종 0.78 (긴급 경고)

### 3. WarningMessage 작성 규칙

#### 기존 (모호)
```
"warningMessage는 2~3문장으로, 왜 스캠으로 의심했는지 설명"
```

#### 개선 (명확)
```
**warningMessage 작성 규칙:**
- confidence 10-25: "일상 대화로 보입니다" 또는 "정상 대화 가능성 높습니다"
- confidence 30-50: "주의가 필요할 수 있습니다" + 이유
- confidence 60+: "사기 가능성이 있습니다" + 구체적 위험 요소 + 행동 권고
- 2-3문장, 한국어, 사용자 친화적
```

**효과:**
- 낮은 confidence에서는 안심시키는 메시지
- 높은 confidence에서는 구체적 행동 지침

---

## 예상 시나리오 비교

### Scenario 1: 친구 간 대화

**입력:**
```
[최근 대화]
- 야 뭐해
- 집에 있어
- 오늘 저녁 먹었어?

[현재 메시지]
돈 좀 빌려줄래? 급하게 필요해

추가 정보:
- 룰 기반 탐지 이유: 위험 키워드 2개 발견: 빌려주세요, 급하게
- 탐지된 키워드: 빌려주세요, 급하게
```

**기존 프롬프트 (예상):**
```json
{
  "confidence": 45,
  "scamType": "UNKNOWN",
  "warningMessage": "금전 요구와 긴급성 표현이 있습니다. 주의가 필요할 수 있습니다.",
  "reasons": ["금전 키워드", "긴급 표현"]
}
```
- Rule 0.5 + LLM 0.45 → **최종 0.47 (알림 발생 가능)**

**개선 프롬프트 (예상):**
```json
{
  "confidence": 15,
  "scamType": "UNKNOWN",
  "warningMessage": "친구 간 일상 대화로 보입니다. 금전 관련 단어가 있지만 대화 맥락이 자연스럽습니다.",
  "reasons": ["금전 키워드 감지"],
  "suspiciousParts": []
}
```
- Rule 0.5 + LLM 0.15 → **최종 0.26 (알림 X)** ✅

---

### Scenario 2: 애매한 상황

**입력:**
```
[최근 대화]
- (최근 대화 없음)

[현재 메시지]
안녕하세요. 계좌번호 알려주시면 입금하겠습니다.

추가 정보:
- 룰 기반 탐지 이유: 위험 키워드 2개 발견: 계좌번호, 입금
- 탐지된 키워드: 계좌번호, 입금
```

**기존 프롬프트 (예상):**
```json
{
  "confidence": 50,
  "scamType": "UNKNOWN",
  "warningMessage": "금전 관련 표현이 있습니다. 주의가 필요합니다.",
  "reasons": ["금전 키워드"]
}
```
- Rule 0.4 + LLM 0.50 → **최종 0.47**

**개선 프롬프트 (예상):**
```json
{
  "confidence": 35,
  "scamType": "UNKNOWN",
  "warningMessage": "맥락이 부족해 판단하기 어렵습니다. 금전 거래 전 상대방 신원을 확인하세요.",
  "reasons": ["맥락 부족", "금전 키워드"],
  "suspiciousParts": ["계좌번호", "입금"]
}
```
- Rule 0.4 + LLM 0.35 → **최종 0.37 (경미한 주의)** ✅

---

### Scenario 3: 명백한 사기

**입력:**
```
[최근 대화]
- (최근 대화 없음)

[현재 메시지]
[긴급] 지금 당장 이 계좌로 송금해주세요. 30분 안에 입금 안하면 법적 조치됩니다. bit.ly/xxx

추가 정보:
- 룰 기반 탐지 이유: 매우 위험 키워드 3개, 단축 URL 감지, 의심스러운 조합: 긴급 + 금전 + URL
- 탐지된 키워드: 긴급송금, 지금당장, 법적조치
```

**기존 프롬프트 (예상):**
```json
{
  "confidence": 80,
  "scamType": "PHISHING",
  "warningMessage": "사기 가능성이 매우 높습니다. 링크를 클릭하지 마세요.",
  "reasons": ["긴급 유도", "피싱 URL"]
}
```
- Rule 0.8 → **강한 신호 → Rule-only 0.8** ✅

**개선 프롬프트 (예상):**
```json
{
  "confidence": 85,
  "scamType": "PHISHING",
  "warningMessage": "명백한 사기 메시지입니다. 긴급성 표현과 금전 요구, 의심 URL이 함께 있습니다. 절대 링크를 클릭하거나 송금하지 마세요.",
  "reasons": ["긴급 금전 요구", "피싱 URL", "협박성 표현"],
  "suspiciousParts": ["지금 당장", "법적 조치", "bit.ly/xxx"]
}
```
- Rule 0.8 → **강한 신호 → Rule-only 0.8** (동일하지만 메시지 개선) ✅

---

## 적용 파일

1. **LLMScamDetector.kt** - Gemini API 프롬프트
2. **OnDeviceScamDetector.kt** - Gemma MediaPipe 프롬프트

두 파일 모두 동일한 프롬프트 구조로 통일하여 일관성 확보

---

## 기대 효과

### 정량적 효과
- **False Positive (오탐) 예상 감소: 40-60%**
  - 친구/가족 일상 대화가 알림으로 뜨는 케이스 대폭 감소
  - Rule 0.4~0.6 + LLM 0.1~0.25 → 최종 0.2~0.35 (알림 임계값 0.5 미만)

- **True Positive (정탐) 유지: 95%+**
  - 강한 신호는 Rule-only로 즉시 탐지
  - 명백한 사기는 LLM도 높은 점수 (70+) 부여

### 정성적 효과
1. **사용자 신뢰도 향상**
   - 불필요한 알림 감소 → 앱에 대한 신뢰
   - 실제 위험 상황에서만 알림 → 알림의 가치 상승

2. **UX 개선**
   - 일상 대화: "정상 대화로 보입니다" 메시지로 안심
   - 애매한 상황: "주의하세요" 정도의 부드러운 경고
   - 명백한 사기: "절대 ~하지 마세요" 강력한 경고

3. **MVP 완성도**
   - 오탐 문제 해결로 QA 통과 가능성 ↑
   - 실사용 단계에서 사용자 이탈 방지

---

## 향후 튜닝 포인트

### A/B 테스트 가능 항목
1. **Confidence 임계값 조정**
   - 일상 대화: 10-25 → 10-30으로 완화
   - 사기 신호: 70+ → 65+로 민감도 증가

2. **WarningMessage 톤 조정**
   - 현재: "일상 대화로 보입니다" (단정)
   - 대안: "일상 대화 가능성이 높습니다" (부드럽게)

3. **Context 길이 영향 분석**
   - 최근 대화 10줄 vs 5줄 vs 전체 화면
   - 맥락이 많을수록 정확도 ↑ vs 처리 시간 ↑

### 실사용 데이터 수집 후
- False Negative (사기를 놓침) 케이스 분석
- 사용자 피드백 ("이 알림은 불필요했어요" 버튼)
- Confidence 분포 분석 (10-25, 30-50, 60+ 각 비율)

---

## MVP 체크리스트

✅ **Confidence 계산 로직 개선** (Rule 30%, LLM 70%)  
✅ **Rule 키워드 정제** (일상 표현 완화, 사기 패턴 보강)  
✅ **LLM 프롬프트 개선** (일상 대화 구분, confidence 가이드 명확화)  
✅ **PII 마스킹** (계좌, 전화, 주민번호 보호)  
✅ **강한 신호 바이패스** (DB 히트 즉시 처리)  

**→ MVP 준비 완료!** 🚀
